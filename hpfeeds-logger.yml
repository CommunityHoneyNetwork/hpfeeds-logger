---
  - hosts: all

    tasks:
      - name: Gather | print os info
        debug:
          msg: "{{ ansible_distribution }}-{{ ansible_distribution_major_version }}"

      - name: Gather | os info
        include_vars: "{{ item }}"
        with_first_found:
          - "{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
          - "{{ ansible_distribution }}.yml"

      - name: Gather | default info
        include_vars:
          file: default.yml
        tags: vars

      - name: hpfeeds-logger | install dependency packages
        package:
          name: "{{ item }}"
        with_items: "{{ pkgs }}"

      - name: hpfeeds-logger | install os-specific dependency packages
        package:
          name: "{{ item }}"
        with_items: "{{ pkgs_osspec }}"

      - name: hpfeeds-logger | update pip
        pip:
          name: pip
          virtualenv: "{{ hpfeeds_logger_dir }}/hpfeeds-logger//hpfeeds-logger-env"
          state: latest
        tags:
          - skip_ansible_lint

      - name: hpfeeds-logger | install python requirements
        pip:
          requirements: "{{ hpfeeds_logger_dir }}/hpfeeds-logger/requirements.txt"
          virtualenv: "{{ hpfeeds_logger_dir }}/hpfeeds-logger/hpfeeds-logger-env"

      - name: hpfeeds-logger | clone hpfeeds for utils
        git:
          repo: "{{ hpfeeds_repo }}"
          version: "{{ hpfeeds_version }}"
          dest: "{{ hpfeeds_dir }}"
          accept_hostkey: yes
          depth: 1

      - name: hpfeeds-logger | link to hpfeeds in hpfeeds-cif
        file:
          state: link
          src: "{{ hpfeeds_dir }}/hpfeeds/lib/hpfeeds.py"
          dest: "{{ hpfeeds_logger_dir }}/hpfeeds-logger/hpfeeds.py"


      - name: hpfeeds-logger | copy sysconfig file
        copy:
          src: hpfeeds-logger.sysconfig
          dest: "{{ sysconfig_dir }}/hpfeeds-logger"
          mode: 0644

      - name: hpfeeds-logger | install Runit
        yum:
          name: "{{ runit_rpm_src }}"
          state: present
        when: ansible_distribution|lower == 'centos'

      - name: hpfeeds-logger | create runit service dirs
        file:
          path: /etc/service/hpfeeds-logger
          state: directory
          mode: 0755

      - name: hpfeeds-logger | copy runit runfile
        template:
          src: hpfeeds-logger.run.j2
          dest: /etc/service/hpfeeds-logger/run
          owner: root
          group: root
          mode: 0755
